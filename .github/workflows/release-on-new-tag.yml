name: CI/CD Release on New Tag

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # åŒ¹é…ç±»ä¼¼ v1.0.0, v2.3.4 çš„ç‰ˆæœ¬æ ‡ç­¾

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    # å…è®¸ GITHUB_TOKEN å†™å…¥æƒé™æ¥åˆ›å»º Release
    permissions:
      contents: write 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # è·å–å®Œæ•´çš„å†å²è®°å½•ï¼Œä»¥ä¾¿åœ¨åç»­æ­¥éª¤ä¸­è·å– Tag ä¿¡æ¯å’Œç”Ÿæˆæ›´æ–°æ—¥å¿—
        with:
          fetch-depth: 0 

      # --- CI æ­¥éª¤ (æ„å»ºå’Œæµ‹è¯•) ---
      
      - name: Setup Node.js (ä»¥ Node é¡¹ç›®ä¸ºä¾‹)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        # é‡è¦çš„ CI æ­¥éª¤ï¼Œç¡®ä¿åªæœ‰é€šè¿‡æµ‹è¯•çš„ä»£ç æ‰ä¼šè¢«å‘å¸ƒ
        run: npm test 

      # --- CD æ­¥éª¤ (å‘å¸ƒ Release) ---
      
      - name: Build Assets (å¯é€‰)
        # å¦‚æœéœ€è¦ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶æˆ–ç”Ÿæˆæ‰“åŒ…æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæ‰§è¡Œ
        run: |
          echo "Release build started for ${{ github.ref_name }}"
          # å‡è®¾æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªå‘å¸ƒæ–‡ä»¶
          echo "Build artifact for ${{ github.ref_name }}" > release-asset.txt

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          # Tag åç§°ï¼šä½¿ç”¨è§¦å‘æ¨é€çš„ Tag åç§°ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰
          tag_name: ${{ github.ref }} 
          # Release åç§°ï¼šä½¿ç”¨ Tag åç§°ä½œä¸ºæ ‡é¢˜
          name: Release ${{ github.ref_name }}
          # body: æ‚¨å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨å·¥å…·è‡ªåŠ¨ç”Ÿæˆæ›´æ–°æ—¥å¿—
          body: |
            ## ğŸ‰ æ–°åŠŸèƒ½å’Œæ”¹è¿›
            - è¯·åœ¨è¿™é‡Œå†™ä¸Šä¸»è¦çš„æ›´æ–°å†…å®¹ã€‚
            
            å®Œæ•´çš„å˜æ›´æ—¥å¿—è¯·å‚è€ƒï¼š[CHANGELOG.md]
          # draft: true # å¦‚æœæ‚¨å¸Œæœ›å…ˆå‘å¸ƒä¸ºè‰ç¨¿ï¼Œå¯ä»¥å¯ç”¨
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          
      - name: Upload Release Asset (å°†ä¸Šä¸€æ­¥ç”Ÿæˆçš„ asset é™„åŠ åˆ° Release)
        uses: actions/upload-release-asset@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # ä¸Šä¸€æ­¥åˆ›å»º Release çš„ URL
          asset_path: ./release-asset.txt # ä¸Šä¼ æ‚¨åœ¨ Build Assets æ­¥éª¤ä¸­ç”Ÿæˆçš„å…·ä½“æ–‡ä»¶
          asset_name: ${{ github.ref_name }}_release.txt